/*
 *	GetFile v4.2 - 2015-07-09
 *	jQuery Upload Plugin
 *	(c) 2015 Syscover S.L. - http://www.syscover.com/
 *	All rights reserved
 */
"use strict";!function(e){var i={options:{urlPlugin:".",folder:null,tmpFolder:null,srcFolder:null,srcFile:null,encryption:!1,filename:null,outputExtension:null,quality:100,multiple:!1,maxFileSize:!1,maxFilesSizes:!1,spinner:!0,mimesAccept:["image/*","video/*","audio/*","text/plain","application/pdf","application/msword","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],crop:{active:!1,width:null,height:null,quality:100,aspectRatio:null,minSize:0,maxSize:0,setSelect:0},resize:{active:!1,width:null,height:null,quality:100,constrainProportions:!0},copies:[{width:100,height:100,quality:100,constrainProportions:!0,prefix:"@2",folder:null,outputExtension:null}],lang:{cropWindowTitle:"Crop image",previewTitle:"Preview",cropButtonText:"Crop",cancelButtonText:"Cancel"},selectorItems:{container:"#cropper-modal",cropButton:"#gfCropButton",cancelButton:"#gfCancelButton",crop:".img-container",image:".img-original",preview:".img-preview"}},items:{container:null,cropButton:null,cancelButton:null,crop:null,image:null,preview:null},properties:{files:null,coords:null,tmpDelete:345600,tmpName:"",oldName:null,extension:null,mime:null,size:null,isImage:null,width:null,height:null,pixelRatio:null,src:null,response:null},callback:null,init:function(i,t,s){if(void 0==i.copies)this.options.copies=[];else for(var o=0;o<i.copies.length;o++)i.copies[o]=e.extend({},this.options.copies[0],i.copies[o]||{});if(void 0!=i.crop&&(i.crop=e.extend({},this.options.crop,i.crop||{})),this.options=e.extend({},this.options,i||{}),this.options.crop.active&&0==e(this.options.selectorItems.container).length){var p=this.options.lang;p.urlPlugin=i.urlPlugin,e.ajax({cache:!1,dataType:"html",context:this,type:"POST",url:this.options.urlPlugin+"/getfile/views/popup.php",data:p,success:function(i){e("body").append(i),this.items={container:e(this.options.selectorItems.container),cropButton:e(this.options.selectorItems.cropButton),cancelButton:e(this.options.selectorItems.cancelButton),crop:e(this.options.selectorItems.crop),image:e(this.options.selectorItems.image),preview:e(this.options.selectorItems.preview)},this.items.cancelButton.on("click",function(){e("#cropper-modal").modal("hide")})},error:function(e){var e={success:!1,error:12,message:"The path: "+this.url+" in the ajax request is not correct, please check the ajax function data"};t(e)}})}else this.items={container:e(this.options.selectorItems.container),cropButton:e(this.options.selectorItems.cropButton),cancelButton:e(this.options.selectorItems.cancelButton),crop:e(this.options.selectorItems.crop),image:e(this.options.selectorItems.image),preview:e(this.options.selectorItems.preview)};if(i.mimesAccept&&(this.options.mimesAccept=i.mimesAccept),this.callback=t,null==this.options.srcFolder){if(this.elem=e(s),this.options.multiple)var n={multiple:!0,logging:!1};else var n={logging:!1};if(0==this.options.mimesAccept)window.fd.logging=!1,fd.jQuery(),e(this.elem).filedrop(n).filedrop().event("send",function(i){e.proxy(this.upload(i),this)}.bind(this));else if("[object Array]"===Object.prototype.toString.call(this.options.mimesAccept))window.fd.logging=!1,fd.jQuery(),e(this.elem).filedrop(n).filedrop().event("send",function(i){e.proxy(this.upload(i),this)}.bind(this));else{var r={success:!1,error:11,message:"The mimesAccept setting must be an array or false. Setting it to false might be dangerous, since it means accepting all file types"};null!=this.callback&&this.callback(r)}}else this.loadSrc();return this},upload:function(i){this.options.spinner&&e.cssLoader.show({urlPlugin:this.options.urlPlugin+"/getfile/libs",useLayer:!1,theme:"carousel"});var t=new FormData;if(this.options.multiple){var s=0;if(i.each(function(e){s+=e.size}),null!=this.options.maxFilesSizes&&0!=this.options.maxFilesSizes&&s>this.options.maxFilesSizes){this.options.spinner&&e.cssLoader.hide();var o=s/1048576,p=this.options.maxFilesSizes/1048576,n={success:!1,error:16,message:"The files whith weighing "+o.toFixed(2)+" Mb they does not been uploaded to the server, to exceed the maximum files sizes allowed of "+p.toFixed(2)+" Mb"};return this.callback(n),!1}var r=0,n=new Array;if(i.each(function(e){if(null!=this.options.maxFileSize&&0!=this.options.maxFileSize&&e.size>this.options.maxFileSize){var i=e.size/1048576,s=this.options.maxFileSize/1048576;n.push({success:!1,error:15,message:"The file "+e.name+" weighing "+i.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed of "+s.toFixed(2)+" Mb"})}else t.append("file"+r,e.nativeFile),r++}.bind(this)),!(r>0))return this.options.spinner&&e.cssLoader.hide(),n={success:!1,multiple:!0,files:n},this.callback(n),!1;n.length>0&&(this.properties.response=n),t.append("nFiles",r)}else{var l=i.first();if(null!=this.options.maxFileSize&&0!=this.options.maxFileSize&&l.size>this.options.maxFileSize||null!=this.options.maxFilesSizes&&0!=this.options.maxFilesSizes&&l.size>this.options.maxFilesSizes){this.options.spinner&&e.cssLoader.hide();var o=event.target.files[0].size/1048576,p=this.options.maxFileSize/1048576,n={success:!1,error:15,message:"The file "+event.target.files[0].name+" weighing "+o.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed of "+p.toFixed(2)+" Mb"};return this.callback(n),!1}t.append("file",l.nativeFile)}t.append("multiple",this.options.multiple),t.append("action","upload"),t.append("folder",this.options.folder),t.append("tmpFolder",this.options.tmpFolder),t.append("cropActive",this.options.crop.active),t.append("resizeActive",this.options.resize.active),t.append("outputExtension",this.options.outputExtension),t.append("encryption",this.options.encryption),t.append("filename",this.options.filename),t.append("mimesAccept",this.options.mimesAccept),t.append("tmpDelete",this.properties.tmpDelete),e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",data:t,type:"POST",dataType:"json",context:this,cache:!1,contentType:!1,processData:!1,xhr:function(){var e=new window.XMLHttpRequest;return e.upload.addEventListener("progress",function(e){if(e.lengthComputable&&null!=this.callback){var i=e.loaded/e.total*100|0,t={success:!0,action:"loading",total:e.total,loaded:e.loaded,percentage:i};this.callback(t)}}.bind(this.context),!1),e},error:function(t){if(this.options.spinner&&e.cssLoader.hide(),this.options.multiple){var s=new Array,o=this;e.each(i,function(e,i){var p=i.size/1048576,n={success:!1,error:13,message:"The file "+i.name+" weighing "+p.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed to server: "+o.prototype.phpIni.postMaxSize,exception:t};s.push(n)}),this.callback(s)}else{var p=i.first(),n=p.size/1048576,s={success:!1,error:13,message:"The file "+p.name+" weighing "+n.toFixed(2)+" Mb has not been uploaded to the server, to exceed the maximum file size allowed to server:"+this.prototype.phpIni.postMaxSize,exception:t};this.callback(s)}},success:function(i){if(this.options.multiple?this.properties.files=i.files:(this.properties.tmpName=i.name,this.properties.size=i.size,this.properties.oldName=i.oldName,this.properties.extension=i.extension,this.properties.mime=i.mime,this.properties.isImage=i.isImage),this.options.crop.active&&i.isImage&&0==this.options.multiple){this.properties.width=i.width,this.properties.height=i.height,this.properties.pixelRatio=window.devicePixelRatio;var t=this;e("#cropper-modal").on("shown.bs.modal",function(){t.crop(t.options.tmpFolder+"/"+i.name)}),this.items.cropButton.off("click"),this.items.cropButton.on("click",e.proxy(this.executeCrop,this)),e("#cropper-modal").modal("show")}else if(this.options.resize.active&&i.isImage||this.options.resize.active&&1==this.options.multiple)if(this.options.multiple){for(var s=!1,o=0;o<this.properties.files.length;o++)1==this.properties.files[o].isImage&&(o=this.properties.files.length,s=!0,this.executeResize());s||null==this.callback||this.callback(i)}else this.executeResize();else if(null!=this.options.outputExtension&&i.isImage||null!=this.options.outputExtension&&1==this.options.multiple)if(this.options.multiple){for(var s=!1,o=0;o<this.properties.files.length;o++)1==this.properties.files[o].isImage&&(o=this.properties.files.length,s=!0,this.executeChangeExtension());s||null==this.callback||this.callback(i)}else this.executeChangeExtension();else if(this.options.copies.length>0&&i.isImage||this.options.copies.length>0&&1==this.options.multiple)if(this.options.multiple){for(var s=!1,o=0;o<this.properties.files.length;o++)1==this.properties.files[o].isImage&&(o=this.properties.files.length,s=!0,this.executeCopies(i));s||null==this.callback||this.callback(i)}else this.executeCopies(i);else null!=this.callback&&(this.options.multiple&&e.merge(i.files,n),this.callback(i));this.options.spinner&&e.cssLoader.hide()}})},loadSrc:function(){var i=this;this.options.tmpFolder=this.options.srcFolder,this.properties.src=this.options.tmpFolder+"/"+this.options.srcFile,e("#cropper-modal").on("shown.bs.modal",function(){i.crop(i.properties.src)}),e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",data:{action:"getinfosrc",src:i.properties.src},type:"POST",dataType:"json",context:this,cache:!1,success:function(i){this.properties.tmpName=i.oldName,this.properties.size=i.size,this.properties.oldName=i.oldName,this.properties.extension=i.extension,this.properties.mime=i.mime,this.properties.isImage=i.isImage,this.properties.width=i.width,this.properties.height=i.height,this.properties.pixelRatio=window.devicePixelRatio,this.items.cropButton.off("click"),this.items.cropButton.on("click",e.proxy(this.executeCrop,this)),e("#cropper-modal").modal("show")}})},crop:function(i){var t=this;if(!e.fn.cropper){var s={success:!1,error:3,message:"Cropper library not loaded"};null!=this.callback&&this.callback(s)}if(this.options.crop.height&&this.options.crop.width)this.options.crop.aspectRatio=this.options.crop.width/this.options.crop.height;else if(isNaN(this.options.crop.aspectRatio)){var s={success:!1,error:4,message:"Width and Height or Ratio must be defined"};null!=this.callback&&this.callback(s)}e(this.items.image).prop("src",i),this.items.image.data("cropper")?(e(this.items.image).cropper("destroy"),e(this.items.image).cropper({aspectRatio:this.options.crop.aspectRatio,preview:".img-preview",crop:function(){t.properties.coords=e(t.items.image).cropper("getData",!0)}})):e(this.items.image).cropper({aspectRatio:this.options.crop.aspectRatio,preview:".img-preview",crop:function(){t.properties.coords=e(t.items.image).cropper("getData",!0)}});var o=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./);o&&(this.properties.tmpNameIE11=this.properties.tmpName,this.properties.sizeIE11=this.properties.size,this.properties.oldNameIE11=this.properties.oldName,this.properties.extensionIE11=this.properties.extension,this.properties.mimeIE11=this.properties.mime,this.properties.isImageIE11=this.properties.isImage)},executeCrop:function(){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:{action:"crop",tmpName:void 0==this.properties.tmpName?this.properties.tmpNameIE11:this.properties.tmpName,size:void 0==this.properties.size?this.properties.sizeIE11:this.properties.size,oldName:void 0==this.properties.oldName?this.properties.oldNameIE11:this.properties.oldName,extension:void 0==this.properties.extension?this.properties.extensionIE11:this.properties.extension,mime:void 0==this.properties.mime?this.properties.mimeIE11:this.properties.mime,isImage:void 0==this.properties.isImage?this.properties.isImageIE11:this.properties.isImage,coords:this.properties.coords,cropWidth:this.options.crop.width,cropHeight:this.options.crop.height,quality:this.options.crop.quality,aspectRatio:this.options.crop.aspectRatio,tmpFolder:this.options.tmpFolder,folder:this.options.folder,outputExtension:this.options.outputExtension,copies:this.options.copies},success:function(i){e("#cropper-modal").modal("hide"),null!=this.callback&&this.callback(i)},error:function(e){null!=this.callback&&this.callback(e.responseJSON)}})},showCropWindow:function(i){this.items.cropButton.off("click"),this.items.cropButton.on("click",e.proxy(this.executeCrop,this)),e("#cropper-modal").modal("show"),null!=i&&i({success:!0,action:"showCropWindow"})},executeResize:function(){if(this.options.multiple)var i={action:"resize",multiple:!0,files:this.properties.files,tmpFolder:this.options.tmpFolder,folder:this.options.folder,quality:this.options.resize.quality,width:this.options.resize.width,height:this.options.resize.height,constrainProportions:this.options.resize.constrainProportions,outputExtension:this.options.outputExtension,copies:this.options.copies};else var i={action:"resize",multiple:!1,tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,quality:this.options.resize.quality,width:this.options.resize.width,height:this.options.resize.height,constrainProportions:this.options.resize.constrainProportions,outputExtension:this.options.outputExtension,copies:this.options.copies};e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:i,success:function(i){null!=this.callback&&(this.options.multiple&&null!=this.properties.response&&e.merge(i.files,this.properties.response),this.callback(i))},error:function(e){null!=this.callback&&this.callback(e.responseJSON)}})},executeChangeExtension:function(){if(this.options.multiple)var i={action:"change",multiple:!0,files:this.properties.files,tmpFolder:this.options.tmpFolder,folder:this.options.folder,outputExtension:this.options.outputExtension,quality:this.options.quality,copies:this.options.copies};else var i={action:"change",multiple:!1,tmpName:this.properties.tmpName,size:this.properties.size,oldName:this.properties.oldName,extension:this.properties.extension,mime:this.properties.mime,isImage:this.properties.isImage,tmpFolder:this.options.tmpFolder,folder:this.options.folder,outputExtension:this.options.outputExtension,quality:this.options.quality,copies:this.options.copies};e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:i,success:function(i){null!=this.callback&&(this.options.multiple&&null!=this.properties.response&&e.merge(i.files,this.properties.response),this.callback(i))},error:function(e){null!=this.callback&&this.callback(e.responseJSON)}})},executeCopies:function(i){this.options.multiple?(i.action="copies",i.multiple=!0,i.files=this.properties.files,i.folder=this.options.folder,i.copies=this.options.copies):(i.action="copies",i.multiple=!1,i.folder=this.options.folder,i.copies=this.options.copies),e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:i,success:function(i){null!=this.callback&&(this.options.multiple&&null!=this.properties.response&&e.merge(i.files,this.properties.response),this.callback(i))},error:function(e){null!=this.callback&&this.callback(e.responseJSON)}})},"delete":function(i,t){e.ajax({url:this.options.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:{action:"delete",filenames:i},success:function(e){null!=t&&t(e)}})}};"function"!=typeof Object.create&&(Object.create=function(e){function i(){}return i.prototype=e,new i}),e.fn.getFile=function(t,s){return i.hasOwnProperty("phpIni")||e.ajax({url:t.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:{action:"getvars"},success:function(e){i.phpIni=e}}),this.data("getFile")?this.data("getFile"):this.data("getFile",Object.create(i).init(t,s,this))},e.getFile=function(t,s){i.hasOwnProperty("phpIni")||e.ajax({url:t.urlPlugin+"/getfile/php/Controllers/server.php",type:"POST",dataType:"json",context:this,cache:!1,data:{action:"getvars"},success:function(e){i.phpIni=e}}),e.data(document,"getFile",Object.create(i).init(t,s,null))}}(jQuery);
