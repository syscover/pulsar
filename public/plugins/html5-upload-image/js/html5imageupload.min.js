/*
 * HTML 5 Image upload script
 * by STBeets
 * bought on CodeCanyon: http://codecanyon.net/item/html-5-upload-image-ratio-with-drag-and-drop/8712634?ref=stbeets
 *
 * Version: 1.4.3
 *
 * add _token variable at lines 261, 769
 * _token: $(element).data('token')
 */
function empty(t){var e,a,i,n,o=[e,null,!1,0,"","0"];for(i=0,n=o.length;n>i;i++)if(t===o[i])return!0;if("object"==typeof t){for(a in t)return!1;return!0}return!1}!function(t,e){"use strict";e.html5imageupload=function(a,i){this.element=i,this.options=e.extend(!0,{},e.html5imageupload.defaults,a,e(this.element).data()),this.input=e(this.element).find("input[type=file]");var n=(e(t),this);this.interval=null,this.drag=!1,this.widthPercentage=100,this.button={},this.button.edit='<div class="btn btn-info btn-edit" title="'+(this.options.editTitle||"Edit")+'"><i class="glyphicon glyphicon-pencil"></i></div>',this.button.saving='<div class="btn btn-warning saving">'+(this.options.saveLabel||"Saving...")+' <i class="glyphicon glyphicon-time"></i></div>',this.button.zoomin='<div class="btn btn-default btn-zoom-in" title="'+(this.options.zoominTitle||"Zoom in")+'"><i class="glyphicon glyphicon-resize-full"></i></div>',this.button.zoomout='<div class="btn btn-default btn-zoom-out" title="'+(this.options.zoomoutTitle||"Zoom out")+'"><i class="glyphicon glyphicon-resize-small"></i></div>',this.button.zoomreset='<div class="btn btn-default btn-zoom-reset" title="'+(this.options.zoomresetTitle||"Fullsize")+'"><i class="glyphicon glyphicon-fullscreen"></i></div>',this.button.cancel='<div class="btn btn-danger btn-cancel" title="'+(this.options.cancelTitle||"Cancel")+'"><i class="glyphicon glyphicon-remove"></i></div>',this.button.done='<div class="btn btn-success btn-ok" title="'+(this.options.okTitle||"Ok")+'"><i class="glyphicon glyphicon-ok"></i></div>',this.button.del='<div class="btn btn-danger btn-del" title="'+(this.options.delTitle||"Delete")+'"><i class="glyphicon glyphicon-trash"></i></div>',this.button.download='<a class="btn btn-warning download"><i class="glyphicon glyphicon-download"></i> '+(this.options.downloadLabel||"Download")+"</a>",this.imageMimes={png:"image/png",bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",jpeg:"image/jpeg",tiff:"image/tiff"},n._init()},e.html5imageupload.defaults={width:null,height:null,image:null,ghost:!0,originalsize:!0,url:!1,removeurl:null,data:{},canvas:!0,canvasImageOnly:!1,ajax:!0,resize:!1,dimensionsonly:!1,editstart:!1,saveOriginal:!1,save:!0,download:!1,smaller:!1,smallerWidth:!1,smallerHeight:!1,background:null,onAfterZoomImage:null,onAfterInitImage:null,onAfterMoveImage:null,onAfterProcessImage:null,onAfterResetImage:null,onAfterCancel:null,onAfterRemoveImage:null,onAfterSelectImage:null},e.html5imageupload.prototype={_init:function(){var a=this,i=a.options,n=a.element,o=a.input;if(empty(e(n)))return!1;if(e(n).children().css({position:"absolute"}),!(t.FormData&&"upload"in e.ajaxSettings.xhr()))return e(n).empty().attr("class","").addClass("alert alert-danger").html("HTML5 Upload Image: Sadly.. this browser does not support the plugin, update your browser today!"),!1;if(!empty(i.width)&&empty(i.height)&&e(n).innerHeight()<=0)return e(n).empty().attr("class","").addClass("alert alert-danger").html("HTML5 Upload Image: Image height is not set and can not be calculated..."),!1;if(!empty(i.height)&&empty(i.width)&&e(n).innerWidth()<=0)return e(n).empty().attr("class","").addClass("alert alert-danger").html("HTML5 Upload Image: Image width is not set and can not be calculated..."),!1;e(n).data("style",e(n).attr("style")),e(n).data("class",e(n).attr("class"));var s,l,r,d;if(i.width=r=i.width||e(n).outerWidth(),i.height=d=i.height||e(n).outerHeight(),e(n).innerWidth()>0?s=e(n).outerWidth():e(n).innerHeight()>0?s=null:empty(i.width)||(s=i.width),e(n).innerHeight()>0?l=e(n).outerHeight():e(n).innerWidth()>0?l=null:empty(i.height)||(l=i.height),l=l||s/(r/d),s=s||l/(d/r),240>s&&e(n).addClass("smalltools smalltext"),e(n).css({height:l,width:s}),a.widthPercentage=e(n).outerWidth()/e(n).offsetParent().width()*100,1==i.resize&&e(t).resize(function(){a.resize()}),a._bind(),(i.required||e(o).prop("required"))&&(a.options.required=!0,e(o).prop("required",!0)),i.ajax||a._formValidation(),empty(i.image)||0!=i.editstart)empty(i.image)||a.readImage(i.image,i.image,i.image,a.imageMimes[i.image.split(".").pop()]);else{e(n).data("name",i.image).append(e("<img />").addClass("preview").attr("src",i.image));var u=e('<div class="preview tools"></div>'),h=(e(""+this.button.edit),e(""+this.button.del));e(h).unbind("click").click(function(t){t.preventDefault(),a.reset()}),0!=i.buttonDel&&e(u).append(h),e(n).append(u)}a.options.onAfterInitImage&&a.options.onAfterInitImage.call(a,a)},_bind:function(){var t=this,a=t.element,i=t.input;e(a).unbind("dragover drop mouseout").on({dragover:function(e){t.handleDrag(e)},drop:function(a){t.handleFile(a,e(this))},mouseout:function(){e(document).unbind("mouseup touchend").on("mouseup touchend",function(e){e.preventDefault(),t.imageUnhandle()})}}),e(i).unbind("change").change(function(i){t.drag=!1,t.handleFile(i,e(a))})},handleFile:function(t,a){t.stopPropagation(),t.preventDefault();var i=this,n=this.options,o=0==i.drag?t.originalEvent.target.files:t.originalEvent.dataTransfer.files;i.drag=!1,null==n.removeurl||empty(e(a).data("name"))||e.ajax({type:"POST",url:n.removeurl,data:{image:e(a).data("name"),_token:e(a).data("token")},success:function(t){i.options.onAfterRemoveImage&&i.options.onAfterRemoveImage.call(i,t,i)}}),e(a).removeClass("notAnImage").addClass("loading");for(var s,l=0;s=o[l];l++)if(s.type.match("image.*")){var r=new FileReader;r.onload=function(t){return function(n){e(a).find("img").remove(),i.readImage(r.result,n.target.result,t.name,t.type)}}(s),r.readAsDataURL(s)}else e(a).addClass("notAnImage");i.options.onAfterSelectImage&&i.options.onAfterSelectImage.call(i,response,i)},readImage:function(t,a,i,n){var o=this,s=this.options,l=this.element;o.drag=!1;var r=new Image;r.onload=function(){var t,d,u,h,m,g,p=e('<img src="'+a+'" name="'+i+'" />');t=u=r.width,d=h=r.height,m=t/d,g=e(l).outerWidth()/e(l).outerHeight(),0==s.originalsize?(u=e(l).outerWidth()+40,h=u/m,h<e(l).outerHeight()&&(h=e(l).outerHeight()+40,u=h*m)):(u<e(l).outerWidth()||h<e(l).outerHeight())&&(1==s.smaller||(g>m?(u=e(l).outerWidth(),h=u/m):(h=e(l).outerHeight(),u=h*m)));var c=parseFloat((e(l).outerWidth()-u)/2),f=parseFloat((e(l).outerHeight()-h)/2);p.css({left:c,top:f,width:u,height:h}),o.image=e(p).clone().data({mime:n,width:t,height:d,ratio:m,left:c,top:f,useWidth:u,useHeight:h}).addClass("main").bind("mousedown touchstart",function(t){o.imageHandle(t)}),o.imageGhost=s.ghost?e(p).addClass("ghost"):null,e(l).append(e('<div class="cropWrapper"></div>').append(e(o.image))),empty(o.imageGhost)||e(l).append(o.imageGhost),o._tools(),e(l).removeClass("loading")},r.src=t},handleDrag:function(t){var e=this;e.drag=!0,t.stopPropagation(),t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy"},imageHandle:function(t){t.preventDefault();var a=t.originalEvent.touches||t.originalEvent.changedTouches?t.originalEvent.touches[0]||t.originalEvent.changedTouches[0]:t,i=this,n=this.element,o=this.image,s=this.options,l=o.outerHeight(),r=o.outerWidth(),d=o.offset().top+l-a.pageY,u=o.offset().left+r-a.pageX;e(document).on({"dragstart mousemove touchmove":function(t){e("body").css({cursor:"move"}),t.stopImmediatePropagation(),t.preventDefault();var a=t.originalEvent.touches||t.originalEvent.changedTouches?t.originalEvent.touches[0]||t.originalEvent.changedTouches[0]:t,h=a.pageY+d-l,m=a.pageX+u-r,g=e(n).outerWidth()!=e(n).innerWidth();0==s.smaller&&(parseInt(h-e(n).offset().top)>0?h=e(n).offset().top+(g?1:0):h+l<e(n).offset().top+e(n).outerHeight()&&(h=e(n).offset().top+e(n).outerHeight()-l+(g?1:0)),parseInt(m-e(n).offset().left)>0?m=e(n).offset().left+(g?1:0):m+r<e(n).offset().left+e(n).outerWidth()&&(m=e(n).offset().left+e(n).outerWidth()-r+(g?1:0))),o.offset({top:h,left:m}),i._ghost()},"dragend mouseup touchend":function(){i.imageUnhandle()}})},imageUnhandle:function(){{var t=this;t.image}e(document).unbind("mousemove touchmove"),e("body").css({cursor:""}),t.options.onAfterMoveImage&&t.options.onAfterMoveImage.call(t,t)},imageZoom:function(t){var a=this,i=a.element,n=a.image,o=a.options;if(empty(n))return a._clearTimers(),!1;var s=n.data("ratio"),l=n.outerWidth()+t,r=l/s;0==o.smaller?(l<e(i).outerWidth()&&(l=e(i).outerWidth(),r=l/s),r<e(i).outerHeight()&&(r=e(i).outerHeight(),l=r*s)):(1>l||1>r)&&(l>r?(l=1,r=l/s):(r=1,l=r*s));var d=n.css("top").replace(/[^-\d\.]/g,"")-(r-n.outerHeight())/2,u=n.css("left").replace(/[^-\d\.]/g,"")-(l-n.outerWidth())/2;0==o.smaller&&(e(i).offset().left-u<e(i).offset().left?u=0:e(i).outerWidth()>u+e(n).outerWidth()&&0>=t&&(u=e(i).outerWidth()-l),e(i).offset().top-d<e(i).offset().top?d=0:e(i).outerHeight()>d+e(n).outerHeight()&&0>=t&&(d=e(i).outerHeight()-r)),n.css({width:l,height:r,top:d,left:u}),a._ghost()},imageCrop:function(){var t,a,i,n,o,s,l,r,d=this,u=d.element,h=d.image,m=d.input,g=d.options,p=g.width!=e(u).outerWidth()?g.width/e(u).outerWidth():1;t=g.width,a=g.height,i=parseInt(Math.round(parseInt(e(h).css("top"))*p)),n=parseInt(Math.round(parseInt(e(h).css("left"))*p)),o=parseInt(Math.round(e(h).width()*p)),s=parseInt(Math.round(e(h).height()*p)),l=e(h).data("width"),r=e(h).data("height"),i=i||0,n=n||0;var c={name:e(h).attr("name"),imageOriginalWidth:l,imageOriginalHeight:r,imageWidth:o,imageHeight:s,width:t,height:a,left:n,top:i};if(e(u).find(".tools").children().toggle(),e(u).find(".tools").append(e(d.button.saving)),1==g.canvas){var f=e('<canvas class="final" id="canvas_'+e(m).attr("name")+'" width="'+t+'" height="'+a+'" style="position:absolute; top: 0; bottom: 0; left: 0; right: 0; z-index:100; width: 100%; height: 100%;"></canvas>');e(u).append(f);var v=e(f)[0].getContext("2d"),b=new Image;b.onload=function(){{var l=e('<canvas width="'+o+'" height="'+s+'"></canvas>'),r=e(l)[0].getContext("2d");e('<img src="" />')}r.drawImage(b,0,0,o,s);var p=new Image;p.onload=function(){if(1==g.canvasImageOnly){var l=o,r=s;0>n?l+=n:n+o>t&&(l=t-n),0>i?r+=i:i+s>a&&(r=a-i);var b=e('<canvas width="'+l+'" height="'+r+'"></canvas>'),w=e(b)[0].getContext("2d");w.drawImage(p,0>n?n:0,0>i?i:0,o,s)}t>o||a>s?v.drawImage(p,n,i,o,s):v.drawImage(p,-1*n,-1*i,t,a,0,0,t,a);var y=1==g.canvasImageOnly?e(b)[0].toDataURL(h.data("mime")):e(f)[0].toDataURL(h.data("mime"));if(0==g.save)e(u).find(".tools .saving").remove(),e(u).find(".tools").children().toggle(),d.options.onSave&&d.options.onSave.call(d,e.extend(c,g.data,{data:y})),d.imageFinal();else if(1==g.ajax)d._ajax(e.extend({data:y},c));else{var I=JSON.stringify(e.extend({data:y},c));e(m).after(e('<input type="text" name="'+e(m).attr("name")+'_values" class="final" />').val(I)),e(m).data("required",e(m).prop("required")),e(m).prop("required",!1),e(m).wrap("<form>").parent("form").trigger("reset"),e(m).unwrap(),e(u).find(".tools .saving").remove(),e(u).find(".tools").children().toggle(),d.imageFinal()}},p.src=e(l)[0].toDataURL(h.data("mime"))},b.src=e(h).attr("src"),g.saveOriginal===!0&&(c=e.extend({original:e(h).attr("src")},c))}else if(1==g.ajax)d._ajax(e.extend({data:e(h).attr("src"),saveOriginal:g.saveOriginal},c));else{var w=e(u).find(".cropWrapper").clone();e(w).addClass("final").show().unbind().children().unbind(),e(u).append(e(w)),d.imageFinal();var y=JSON.stringify(c);e(m).after(e('<input type="text" name="'+e(m).attr("name")+'_values" class="final" />').val(y))}},_ajax:function(t){var a=this,i=a.element,n=(a.image,a.options);1==n.dimensionsonly&&delete t.data,e.ajax({type:"POST",url:n.url,data:e.extend(t,n.data),success:function(t){if("success"==t.status){var o=t.url.split("?");e(i).find(".tools .saving").remove(),e(i).find(".tools").children().toggle(),e(i).data("name",o[0]),e(i).data("filename",t.filename),1!=n.canvas&&e(i).append(e('<img src="'+o[0]+'" class="final" style="width: 100%" />')),a.imageFinal()}else e(i).find(".tools .saving").remove(),e(i).find(".tools").children().toggle(),e(i).append(e('<div class="alert alert-danger">'+t.error+"</div>").css({bottom:"10px",left:"10px",right:"10px",position:"absolute",zIndex:99})),setTimeout(function(){a.responseReset()},2e3)},error:function(t){e(i).find(".tools .saving").remove(),e(i).find(".tools").children().toggle(),e(i).append(e('<div class="alert alert-danger"><strong>'+t.status+"</strong> "+t.statusText+"</div>").css({bottom:"10px",left:"10px",right:"10px",position:"absolute",zIndex:99})),setTimeout(function(){a.responseReset()},2e3)}})},imageReset:function(){{var t=this,a=t.image;t.element}e(a).css({width:a.data("useWidth"),height:a.data("useHeight"),top:a.data("top"),left:a.data("left")}),t._ghost(),t.options.onAfterResetImage&&t.options.onAfterResetImage.call(t,t)},imageFinal:function(){var t=this,a=t.element,i=t.input,n=t.options;e(a).addClass("done"),e(a).children().not(".final").hide();var o=e('<div class="tools final">');if(0!=n.buttonEdit&&e(o).append(e(t.button.edit).click(function(){e(a).children().show(),e(a).find(".final").remove(),e(i).data("valid",!1)})),0!=n.buttonDel&&e(o).append(e(t.button.del).click(function(){t.reset()})),e(a).append(o),e(a).unbind(),1==n.download){var s=e('<div class="download final"/>');e(s).append(e(t.button.download).attr("download",e(t.image).attr("name")).click(function(){e(this).attr("href",e(a).find("canvas.final")[0].toDataURL(t.image.data("mime")))})),e(a).append(s)}e(i).unbind().data("valid",!0),t.options.onAfterProcessImage&&t.options.onAfterProcessImage.call(t,t)},responseReset:function(){var t=this,a=t.element;e(a).find(".alert").remove()},reset:function(){var t=this,a=t.element,i=t.input,n=t.options;t.image=null,e(a).find(".preview").remove(),e(a).removeClass("loading done").children().show().not("input[type=file]").remove(),e(i).wrap("<form>").parent("form").trigger("reset"),e(i).unwrap(),e(i).prop("required",e(i).data("required")||n.required||!1).data("valid",!1),t._bind(),null==n.removeurl||empty(e(a).data("name"))||e.ajax({type:"POST",url:n.removeurl,data:{image:e(a).data("name"),_token:e(a).data("token")},success:function(e){t.options.onAfterRemoveImage&&t.options.onAfterRemoveImage.call(t,e,t)}}),e(a).data("name",null),t.imageGhost&&(e(t.imageGhost).remove(),t.imageGhost=null),t.options.onAfterCancel&&t.options.onAfterCancel.call(t)},resize:function(){var t=this,a=t.options,i=t.element,n=t.image;if(a.resize!==!0)return!1;var o=e(i).outerWidth(),s=e(i).offsetParent().width()*(t.widthPercentage/100),l=s/o,r=e(i).outerHeight()*l;return e(i).css({height:r,width:s}),240>s?e(i).hasClass("smalltools smalltext")||e(i).addClass("smalltools smalltext smalladded"):e(i).hasClass("smalladded")&&e(i).removeClass("smalltools smalltext smalladded"),empty(n)||(e(n).css({left:e(n).css("left").replace(/[^-\d\.]/g,"")*l+"px",top:e(n).css("top").replace(/[^-\d\.]/g,"")*l+"px"}),e(n).width(e(n).width()*l),e(n).height(e(n).height()*l),t._ghost()),!0},reinit:function(){{var t=this;t.element}return this.resize(),this._bind(),!0},modal:function(){var t=this,a=t.element;return e(a).attr("style",e(a).data("style")),e(a).attr("class",e(a).data("class")),t._init(),this},_ghost:function(){var t=this,a=t.options,i=t.image,n=t.imageGhost;1!=a.ghost||empty(n)||e(n).css({width:i.css("width"),height:i.css("height"),top:i.css("top"),left:i.css("left")})},_tools:function(){var a=this,i=a.element,n=e('<div class="tools"></div>'),o=a.options;0!=o.buttonZoomin&&e(n).append(e(a.button.zoomin).on({"touchstart mousedown":function(e){e.preventDefault(),a.interval=t.setInterval(function(){a.imageZoom(2)},1)},"touchend mouseup mouseleave":function(e){e.preventDefault(),t.clearInterval(a.interval),a.options.onAfterZoomImage&&a.options.onAfterZoomImage.call(a,a)}})),0!=o.buttonZoomreset&&e(n).append(e(a.button.zoomreset).on({"touchstart click":function(t){t.preventDefault(),a.imageReset()}})),0!=o.buttonZoomout&&e(n).append(e(a.button.zoomout).on({"touchstart mousedown":function(e){e.preventDefault(),a.interval=t.setInterval(function(){a.imageZoom(-2)},1)},"touchend mouseup mouseleave":function(e){e.preventDefault(),t.clearInterval(a.interval),a.options.onAfterZoomImage&&a.options.onAfterZoomImage.call(a,a)}})),0!=o.buttonCancel&&e(n).append(e(a.button.cancel).on({"touchstart touchend click":function(t){t.preventDefault(),a.reset()}})),0!=o.buttonDone&&e(n).append(e(a.button.done).on({"touchstart click":function(t){t.preventDefault(),a.imageCrop()}})),e(i).append(e(n))},_clearTimers:function(){for(var e=t.setInterval("",9999),a=1;e>a;a++)t.clearInterval(a)},_formValidation:function(){{var t=this,a=t.element;t.input}e(a).closest("form").submit(function(t){return e(this).find("input[type=file]").each(function(a,i){return e(i).prop("required")&&e(i).data("valid")!==!0?(t.preventDefault(),!1):void 0}),!0})}},e.fn.html5imageupload=function(t){return e.data(this,"html5imageupload")?void 0:e(this).each(function(){e.data(this,"html5imageupload",new e.html5imageupload(t,this))})}}(window,jQuery);